from numpy import *
from math import sqrt
import numpy as np
import scipy
import math
import sys

# Input: expects Nx3 matrix of points
# Returns R,t
# R = 3x3 rotation matrix
# t = 3x1 column vector

# Test Data

Bt = np.array([[0.6249680439829423, 0.15492054755989823, 0.3506416957265683], [0.7426080828035835, -0.09055332926428275, 0.26784875014502196], [0.7402403583462037, -0.28506058383421895, 0.2455195522525217], [0.5916643159087188, -0.41267442978390606, 0.27585571395410713], [0.8098046202326669, -0.3403352103944105, 0.1193111665220992], [0.9028417007485983, 0.23106125801460461, 0.20195310007787837], [0.8660834343643586, 0.43313587378965807, 0.3285059648210167], [0.8240208958017339, 0.3899509897513471, 0.08020270302867086], [0.7422892136837934, 0.5440339882344308, 0.4018854850092229], [0.868741107231356, 0.41704499814008406, 0.4265116979473516], [0.9526800249434206, 0.302198274129656, 0.4216573041652563], [0.9446863763827167, 0.25884865611797875, 0.25106387049647727], [0.8737795743596966, 0.1975727459096958, 0.11420510928528861], [0.7267965011239055, 0.18114490464080008, 0.14766631407994518], [0.7867210101199069, 0.00949807125052149, 0.03812724549043858], [0.8358777369432269, -0.2156296953544522, 0.13317595244656225], [0.8250067168562262, -0.4071683466023415, 0.07931831013013817], [0.6633118968278353, -0.47799041051585595, 0.0747661950787407], [0.5229892422050696, -0.4609744101927879, 0.07753698583821106], [0.7200753645735842, -0.478098532518893, 0.21381044336864213], [0.7271051617775465, -0.6179759831325256, 0.07623626963180934], [0.8764957593548671, -0.5467421077707075, 0.08942206661992591], [0.9927204424286364, -0.42451091610932373, 0.15589909639946486], [0.9022665052383183, -0.48055043864639524, -0.05065742635014402], [0.7192689014169413, -0.5020434110483921, -0.07666316903570652], [0.5924256335863011, -0.476390166276922, -0.036561717647312655], [0.49598183552903363, -0.49724007189813196, -0.020468210021701516], [0.5303171028881777, -0.6643002441206369, -0.058513604084683604], [0.8913801476509761, -0.4664205786599739, 0.06321318311752992], [0.9973027257687116, -0.27222372150286106, 0.1635709823790167], [0.9361438501353735, 0.05873119501839846, 0.14414763419243268], [0.9388872230049117, 0.07339976788658925, 0.1601232882037201], [0.8868219637664071, 0.24765044249951976, 0.30161568307386455], [0.919294255277531, 0.2708974317686774, 0.41695632447210484], [0.8663061479051266, 0.23302269893005487, 0.10167626330427862], [0.8326283659350802, 0.3699143351893524, 0.23346548486661683], [0.6583118424887014, 0.31839809569870003, -0.057111669896780404], [0.5171737473670003, 0.30914324418941197, -0.010766197658111189], [0.44536173978699495, 0.33450357912444084, 0.059304558469322644], [0.49749447805405095, 0.23544984756641482, 0.014903481979303357], [0.728522007673693, 0.31639200082506785, 0.01618989587450238], [0.7167513130480153, 0.5460148992457251, 0.40231469042240137], [0.7007724982822126, 0.5564687710177691, 0.528637434946519], [0.8603634751712946, 0.386352855592172, 0.4433302663535128], [0.8866086884255042, 0.3372768649525272, 0.31688828943511654], [0.9242961489074344, 0.26576273810364237, 0.22584235980985967], [0.7262078207729651, 0.2515071886042479, 0.22554456909906803], [0.6063448285338021, 0.27787197425905097, 0.2661596302112191], [0.5544881871666536, 0.06205697625689584, 0.25654905337709283], [0.6031237510304188, -0.12870489540586288, 0.2799693834239188], [0.6186341245618279, -0.30842793844266375, 0.23620247431683616], [0.4805528566151642, -0.07244580721739885, 0.19256588728169088], [0.5796184400743277, -0.025833457852769293, 0.05610213684661855], [0.7399843526326826, 0.1436667454208409, -0.01264654197972721], [0.8095394748077162, 0.3623722825587271, 0.06552122448874476], [0.5880304552466179, 0.3784406200526547, 0.04584716502194683], [0.7559037895320384, 0.43801767550257587, 0.05823293052645105], [0.6398134513491232, 0.5916400133118472, 0.21411865528264923], [0.6630730650839229, 0.5973084048020618, 0.3527224581368016], [0.6725869321965144, 0.5888357670561569, 0.4655965342574181], [0.8128170429035335, 0.4661440034856922, 0.4606156141838919], [0.8851329519803521, 0.3186870210829884, 0.3562563624511784], [0.8512472528415509, 0.15864652638772303, 0.2164987894033483], [0.7566481962911148, -0.04156356667417224, 0.1508707458418693], [0.7020282597556115, -0.28032818088947037, 0.1332597216877395], [0.5949419149009528, -0.5110850704666172, 0.1259346100805906], [0.5719903238000107, -0.46103468179281015, 0.22367206695095063], [0.576868810372121, -0.6230635291919125, 0.12170201040848523], [0.7708606238932739, -0.5964053895889774, 0.018371702335069823], [0.801929807223733, -0.41655194968751935, -0.08915348659675362], [0.7626661735780126, -0.5867183361101385, -0.10701464341364672], [0.824360285119696, -0.5781238127029968, 0.008610980034347862], [0.7427378485845754, -0.37223508085827345, 0.11964635279927902], [0.6317790695044238, -0.20943530187750647, 0.2642359740665788], [0.4773698534993349, -0.20864866877241897, 0.15089454996473955], [0.39928093614737004, -0.31881085135782294, 0.016028675906412587], [0.7965437063781095, -0.2389407739411434, 0.08656518783557751], [0.8020464947826372, 0.06216643419167134, 0.20959447642979026], [0.7761071872031309, 0.07635613917684891, 0.2056659439296573], [0.6068605941533427, 0.1650857391452279, 0.2841042056085974], [0.7337636485326249, 0.2925613690379901, 0.38134344997302905], [0.8824272751967632, 0.28507956829693165, 0.26747363660454726], [0.8809862056171089, 0.16575616161523082, 0.008288813940055853], [0.7809685616580384, 0.14013390034684048, -0.11544488852797517], [0.530847083031353, 0.10664796183251485, -0.06991470839850814], [0.3869635791352929, 0.08506119483960062, -0.005657418273886803], [0.552480693963814, 0.2627522818939845, 0.21247323313017402], [0.7214297577677773, 0.3138400422346961, 0.29622008099421726], [0.8764724846233137, 0.2854887548667785, 0.29664235276130996], [0.9321674722688225, 0.24401572539289534, 0.46145898934791263], [0.7631181472514721, 0.3706217952029607, 0.20698181717482692], [0.7076433410364874, 0.4432116579986522, 0.3053543700488455], [0.6575186148966761, 0.5136400146898997, 0.390093186814179], [0.7654773113036404, 0.38889053860645995, 0.14517741813238405], [0.8236224272668218, 0.3626692358791676, 0.25324638786464754], [0.7967345254250265, 0.3476438563590967, 0.39896716518308706], [0.7558795429631037, 0.5225538484670956, 0.47820074398918316], [0.722818140102262, 0.5555493914131786, 0.5249364786375982], [0.7159513194906073, 0.559274772893584, 0.3534450536276388], [0.703573391650034, 0.5616297590855445, 0.4867933255711572], [0.6971595124270921, 0.4678520468941258, 0.4950683419962129], [0.8561145049381137, 0.39839746448699365, 0.42215451929601416], [0.6308517965878793, 0.4936717114672113, -0.03819386261846816], [0.47852231021144165, 0.37433078031681455, -0.050158515740819566], [0.516545473556141, 0.1977024396963668, -0.05216848263572226], [0.6440485971366848, 0.12600746798007148, 0.1425901509977087], [0.8156141366773584, -0.036623416506494144, 0.20177797456017915], [0.7011975545029729, -0.01812607826459271, -0.028352545624064286], [0.49555505984959264, 0.01924360850181263, -0.04255647412219994], [0.3781568608776023, 0.02589818491152082, -0.0002015771290827459], [0.5574013788835805, -0.07901698086068827, -0.03948265922619833], [0.6504017211698074, -0.27228140386194627, -0.020046653860837427], [0.701084300453251, -0.3337548106381012, 0.09252182919723209], [0.9109126920503645, -0.206641957433625, 0.07312126107262926], [0.9694663071393307, -0.011742595459219275, 0.11928838819003348], [0.9093611262111617, 0.24427719064962572, 0.24092242865370536], [0.9649503197376408, 0.30469270319361186, 0.3330759193538987], [0.8648515178300213, 0.4325377590376219, 0.48868272215426584], [0.7314274981499295, 0.33593457910125635, 0.34415561702774433], [0.6250423279579581, 0.22254942220890128, 0.32513436875132634], [0.4588632091635857, 0.16107266306352047, 0.3454457659512161], [0.4945022080411896, -0.051154527515179515, 0.37276717131445036], [0.5059641702499885, -0.2181317459483286, 0.25115289216436454], [0.4752189438043714, -0.43604514350521273, 0.22015795344291897], [0.6038059605588212, -0.5032310607998851, 0.15629399184245069], [0.7873853507666524, -0.44787928798975113, 0.06496868973967615], [0.9100675913190303, -0.06622314381139287, 0.05678496878699445], [0.9028813216878622, 0.2585780532194942, 0.14346280150336357], [0.8511609018187619, 0.4156623299649347, 0.2918775474895069], [0.751639139278262, 0.5104878998867703, 0.48472486964181305], [0.6465068319624009, 0.31985417662703314, 0.4298632601132279], [0.5076729070305901, 0.003846085132967053, 0.2554953397614705], [0.641353384657201, -0.09494261712374821, 0.21620353873581213], [0.7637843172517229, -0.23761242662511461, 0.22471753771762237], [0.8292357724528573, -0.47284937947652733, 0.08983940164732163], [0.6313240720578414, -0.5215661364003676, 0.1488408011011157], [0.48159189545977665, -0.5247472230092519, 0.1727019315870274], [0.6836353253831166, -0.6743609758899849, 0.07841090297360094], [0.8577009710205095, -0.5825679494126335, 0.041565938204466676], [0.980369910742492, -0.19298757699496297, 0.0426755222782575], [0.9319197266813153, 0.11275642890193646, 0.10807387557875395], [0.8462279522760127, 0.39525843875656186, 0.34234068724193906], [0.5749941063669014, 0.24522769943732717, 0.2980961233667935], [0.5078064348315979, 0.09616083813039264, 0.38591458537129647], [0.5772162738559615, -0.182181113694337, 0.3618805429618297], [0.625048289406376, -0.38103551909070044, 0.25541455439517247], [0.5984897671153985, -0.5819163090510857, 0.1545849328610509], [0.7316094169603312, -0.6574148384250778, 0.060190459554933524], [0.7399694536116627, -0.38749612454327964, -0.08552777458158231], [0.7566316779395044, -0.07692713361620707, 0.0014017378329347213], [0.7530436476614747, 0.1527678457908169, 0.08121053716997091], [0.8457550798863778, 0.3019827352054508, 0.27788837067771516], [0.7796017825589218, 0.36934697973389974, 0.3758092409129675], [0.8626917468986949, 0.4277943795647353, 0.35395410454459747], [0.7428433895315505, 0.5115190098607372, 0.4817336140945772], [0.6754274366665538, 0.13127580809951472, 0.3040499210013563], [0.6854879873269772, -0.07086132307839288, 0.3708938070026393], [0.6187104421597837, -0.24282880189634504, 0.2945775973324104], [0.49283302483143343, -0.3485966567935266, 0.3358628400094831], [0.5715910259613204, -0.31162588864847984, 0.16286868094708287], [0.6744716909666971, -0.20422382043399542, 0.0798446030671183], [0.687055192536551, -0.06387354077066604, -0.08707074547006108], [0.7713916047265714, 0.08720005799715794, -0.054449096633268565], [0.5859019559619099, 0.027717800578616017, 0.014129915663873699], [0.4477044134967422, -0.02766070070001357, 0.08938438269208962], [0.8255006069410357, 0.19479058780938172, 0.22172836967315762], [0.773114020949449, 0.3949305239263443, 0.3555846480389101], [0.676745535109226, 0.5471351272965672, 0.45445032860738255], [0.5258142726917824, 0.3619225696512739, 0.35889297118618096], [0.49293835136659814, 0.0987851846093408, 0.3833659633354723], [0.5645784127865654, -0.12850232594731978, 0.41142090868958386], [0.6141436844849307, -0.1946771043887863, 0.23015571320754236], [0.6415287454483211, -0.33610038483352944, 0.26498234582134556], [0.7771538814505125, -0.43450760464254246, 0.10101016728964929], [0.9022911365264747, -0.13599112472332017, 0.07752891901929275], [0.9890363718974781, 0.08388929794428483, 0.1073145297518603], [0.8848947685073274, 0.3514068093873829, 0.2441137548525412], [0.8472074477939421, 0.38113778103152285, 0.4062478148528096], [0.6896354208725318, 0.2828422428963415, 0.2908961293794406], [0.6388759073391871, 0.028229208271038267, 0.3746742641122618], [0.6324657516082955, -0.06780695162701451, 0.3303269062759444], [0.4541890880165954, -0.08147944708584716, 0.22814961003307507], [0.3714043451765748, -0.05877990846591517, 0.14988193064184488], [0.3760016323418334, -0.03756099230658003, 0.05302328719284914], [0.5304450833988466, -0.2419101248571478, 0.07611842346649095], [0.5768526827513586, -0.3727207386027997, 0.1143202650410841], [0.6167591681482153, -0.5619327009708236, 0.024786552248313973], [0.8514915264510324, -0.5493595168597766, 0.0038316770742903884], [0.98640142282322, 0.003880918354545685, 0.08470348515194995], [0.6828262972567366, 0.4605380952441101, 0.28792581183319443], [0.5883100657907929, 0.5804027779891643, 0.47378883369930663], [0.7556543881387661, 0.4820933063898547, 0.47099328539054136], [0.6189263230423855, 0.39732041477335, 0.3865282662389317], [0.5021720590942821, 0.22177898354702308, 0.34937735626813216], [0.6248888684272174, 0.11353480719716331, 0.3282851780710397], [0.7226153170105118, -0.016894588454524233, 0.2755255632609551], [0.8135705577837526, -0.14911996420810705, 0.29732394547560326], [0.7519190275696553, -0.32022839878429576, 0.16232037823306986], [0.65309981577698, -0.4804169463784257, 0.10476635489347555], [0.812900267372919, -0.5710757022471594, 0.0365598243978382], [0.5567468071483193, -0.7843877951452133, 0.019697258283859702], [0.46604312439553625, -0.6507766347827159, 0.028072701352893872], [0.773636482258464, -0.14452595807074653, 0.09814167832276618], [0.6086460623554525, 0.2014497595550121, 0.19234693997843041], [0.7635623653834158, 0.3092038589460852, 0.24467358478171092], [0.9096112765951694, 0.230778955074238, 0.296424662619826], [0.7321573999376594, 0.44626238717505956, 0.47326914219139987], [0.4761925563567823, 0.3652386357688213, 0.36430377478288806], [0.42808499251621746, 0.2761198970228978, 0.35017031854249125], [0.7739718220363372, -0.030804390424643946, 0.33087555387722645], [1.0083383877070144, 0.16398626565719104, 0.22139742085987785], [0.6335120093787318, -0.11357198919933, -0.077797026913453], [0.6838506263282073, -0.2731111380267536, -0.060627085249349136]])

Kt = np.array([[361.0, 94.0, 0.4227166175842285], [346.0, 80.0, 0.41152340173721313], [381.0, 62.0, 0.3705737590789795], [449.0, 41.0, 0.33633193373680115], [351.0, 103.0, 0.40648889541625977], [215.0, 162.0, 0.5530486702919006], [164.0, 161.0, 0.14842438697814941], [218.0, 272.0, 0.1831064671278], [190.0, 171.0, 0.14714784920215607], [160.0, 102.0, 0.6477717757225037], [156.0, 66.0, 0.6887137293815613], [183.0, 144.0, 0.5399302244186401], [239.0, 202.0, 0.5176207423210144], [305.0, 204.0, 0.25004661083221436], [305.0, 187.0, 0.25004661083221436], [325.0, 108.0, 0.42811858654022217], [340.0, 123.0, 0.42340466380119324], [415.0, 106.0, 0.20905131101608276], [460.0, 115.0, 0.3310078978538513], [402.0, 53.0, 0.3828110098838806], [452.0, 240.0, 0.19056497514247894], [353.0, 85.0, 0.419150173664093], [305.0, 70.0, 0.32607460021972656], [338.0, 138.0, 0.41972777247428894], [392.0, 153.0, 0.21200820803642273], [432.0, 150.0, 0.19765056669712067], [470.0, 145.0, 0.23774555325508118], [467.0, 130.0, 0.3227464556694031], [341.0, 101.0, 0.4207536578178406], [303.0, 84.0, 0.4591933488845825], [250.0, 150.0, 0.5372755527496338], [239.0, 144.0, 0.534179151058197], [219.0, 124.0, 0.5569021105766296], [184.0, 59.0, 0.6050717830657959], [232.0, 209.0, 0.534179151058197], [211.0, 193.0, 0.1694754809141159], [308.0, 319.0, 0.19653178751468658], [378.0, 326.0, 0.22303402423858643], [423.0, 314.0, 0.20630647242069244], [406.0, 289.0, 0.21545666456222534], [283.0, 282.0, 0.20499108731746674], [198.0, 157.0, 0.2548946440219879], [197.0, 65.0, 0.5976141095161438], [162.0, 65.0, 0.6848165392875671], [182.0, 123.0, 0.6332942843437195], [190.0, 155.0, 0.5714826583862305], [287.0, 177.0, 0.48692426085472107], [350.0, 167.0, 0.2330997884273529], [404.0, 125.0, 0.21545666456222534], [411.0, 72.0, 0.3684908151626587], [423.0, 69.0, 0.34586194157600403], [448.0, 134.0, 0.22838260233402252], [397.0, 189.0, 0.223806694149971], [310.0, 243.0, 0.24613089859485626], [232.0, 268.0, 0.18746449053287506], [331.0, 313.0, 0.23896989226341248], [237.0, 310.0, 0.17573542892932892], [255.0, 331.0, 0.13343587517738342], [221.0, 226.0, 0.11709601432085037], [204.0, 130.0, 0.619528591632843], [158.0, 90.0, 0.6644574999809265], [186.0, 115.0, 0.5938839912414551], [247.0, 139.0, 0.5176207423210144], [333.0, 140.0, 0.4185790419578552], [385.0, 111.0, 0.22345823049545288], [429.0, 82.0, 0.3563719093799591], [458.0, 57.0, 0.32444527745246887], [464.0, 75.0, 0.3277033269405365], [391.0, 105.0, 0.21397462487220764], [361.0, 166.0, 0.2219570428133011], [395.0, 148.0, 0.21126234531402588], [372.0, 108.0, 0.3770119249820709], [380.0, 111.0, 0.2142457515001297], [418.0, 76.0, 0.3776346445083618], [474.0, 130.0, 0.3243987560272217], [435.0, 202.0, 0.19597239792346954], [345.0, 133.0, 0.4105011820793152], [306.0, 134.0, 0.4458325505256653], [309.0, 138.0, 0.4559742510318756], [379.0, 139.0, 0.22041280567646027], [283.0, 101.0, 0.4792653024196625], [212.0, 145.0, 0.5654681921005249], [255.0, 235.0, 0.2823328971862793], [301.0, 275.0, 0.25392916798591614], [394.0, 279.0, 0.21975019574165344], [243.0, 248.0, 0.2841693162918091], [426.0, 216.0, 0.20007458329200745], [301.0, 166.0, 0.47326305508613586], [211.0, 136.0, 0.5802730321884155], [187.0, 46.0, 0.4434766173362732], [252.0, 219.0, 0.30801770091056824], [258.0, 196.0, 0.49375349283218384], [264.0, 166.0, 0.4824674129486084], [246.0, 242.0, 0.17535088956356049], [216.0, 180.0, 0.5347753167152405], [232.0, 108.0, 0.5385343432426453], [168.0, 95.0, 0.687461793422699], [182.0, 67.0, 0.24317798018455505], [203.0, 210.0, 0.14402654767036438], [200.0, 85.0, 0.24993963539600372], [232.0, 53.0, 0.40569910407066345], [169.0, 89.0, 0.6385154128074646], [292.0, 385.0, 0.18792639672756195], [380.0, 377.0, 0.22226494550704956], [393.0, 310.0, 0.21397462487220764], [351.0, 185.0, 0.23926618695259094], [302.0, 121.0, 0.46563151478767395], [342.0, 200.0, 0.23270557820796967], [407.0, 236.0, 0.20268037915229797], [469.0, 239.0, 0.18973679840564728], [406.0, 216.0, 0.20268037915229797], [393.0, 168.0, 0.2244008630514145], [389.0, 111.0, 0.21861180663108826], [307.0, 124.0, 0.4497254192829132], [249.0, 142.0, 0.5372755527496338], [245.0, 143.0, 0.5417642593383789], [159.0, 115.0, 0.5204991102218628], [143.0, 50.0, 0.700056791305542], [255.0, 148.0, 0.5170159339904785], [355.0, 126.0, 0.4179132878780365], [443.0, 114.0, 0.3668052852153778], [456.0, 51.0, 0.3328437805175781], [463.0, 80.0, 0.3293555974960327], [132.0, 418.0, 0.3785569965839386], [447.0, 73.0, 0.3469040095806122], [376.0, 100.0, 0.3891478478908539], [276.0, 157.0, 0.47902292013168335], [214.0, 191.0, 0.5690866708755493], [179.0, 176.0, 0.15476413071155548], [181.0, 69.0, 0.6203370690345764], [326.0, 94.0, 0.42811858654022217], [429.0, 124.0, 0.22048833966255188], [386.0, 109.0, 0.21020746231079102], [360.0, 74.0, 0.401267945766449], [368.0, 89.0, 0.3964199125766754], [443.0, 70.0, 0.3364654779434204], [289.0, 203.0, 0.25298330187797546], [431.0, 77.0, 0.3420672118663788], [371.0, 93.0, 0.3976519703865051], [280.0, 141.0, 0.48286309838294983], [234.0, 180.0, 0.5423957109451294], [185.0, 140.0, 0.5399302244186401], [372.0, 147.0, 0.22344252467155457], [437.0, 69.0, 0.36533957719802856], [433.0, 31.0, 0.3529740869998932], [434.0, 50.0, 0.3618534803390503], [459.0, 67.0, 0.33467963337898254], [417.0, 84.0, 0.35322195291519165], [383.0, 170.0, 0.21222691237926483], [339.0, 195.0, 0.2372656762599945], [304.0, 212.0, 0.2578350305557251], [224.0, 148.0, 0.5654681921005249], [224.0, 119.0, 0.5739656686782837], [159.0, 146.0, 0.15281030535697937], [185.0, 97.0, 0.2667279839515686], [336.0, 108.0, 0.42889603972435], [373.0, 36.0, 0.3891478478908539], [424.0, 39.0, 0.3568897843360901], [290.0, 201.0, 0.24900613725185394], [438.0, 104.0, 0.3455112874507904], [384.0, 148.0, 0.21149256825447083], [358.0, 231.0, 0.22817648947238922], [311.0, 256.0, 0.24613089859485626], [392.0, 225.0, 0.2145427018404007], [459.0, 198.0, 0.192955881357193], [247.0, 164.0, 0.26252982020378113], [213.0, 131.0, 0.5714826583862305], [222.0, 114.0, 0.26728296279907227], [370.0, 145.0, 0.2249573916196823], [438.0, 77.0, 0.35258474946022034], [237.0, 253.0, 0.2817130386829376], [412.0, 88.0, 0.35138610005378723], [426.0, 49.0, 0.3603484332561493], [379.0, 98.0, 0.39291802048683167], [302.0, 146.0, 0.4695250988006592], [235.0, 175.0, 0.534179151058197], [189.0, 183.0, 0.18468649685382843], [187.0, 93.0, 0.6050717830657959], [292.0, 145.0, 0.4797154366970062], [377.0, 57.0, 0.3891478478908539], [390.0, 57.0, 0.38363945484161377], [474.0, 121.0, 0.3278016149997711], [227.0, 276.0, 0.30667179822921753], [212.0, 279.0, 0.30108317732810974], [446.0, 149.0, 0.2267303168773651], [441.0, 106.0, 0.3418395519256592], [441.0, 112.0, 0.3400036692619324], [368.0, 111.0, 0.39399588108062744], [246.0, 162.0, 0.5213027596473694], [281.0, 250.0, 0.26216670870780945], [283.0, 177.0, 0.2915428876876831], [190.0, 92.0, 0.6031054854393005], [324.0, 136.0, 0.5348355770111084], [408.0, 123.0, 0.24104803800582886], [364.0, 94.0, 0.3950798511505127], [344.0, 93.0, 0.41432034969329834], [331.0, 53.0, 0.42233824729919434], [374.0, 89.0, 0.3951902985572815], [424.0, 95.0, 0.3493666350841522], [380.0, 101.0, 0.39646220207214355], [473.0, 88.0, 0.32947975397109985], [252.0, 239.0, 0.280626505613327], [336.0, 136.0, 0.41972777247428894], [354.0, 188.0, 0.23063813149929047], [252.0, 170.0, 0.5133320689201355], [202.0, 108.0, 0.5870100259780884], [227.0, 81.0, 0.5521681308746338], [393.0, 156.0, 0.21530012786388397], [454.0, 145.0, 0.2561505138874054], [325.0, 52.0, 0.42427024245262146], [187.0, 137.0, 0.3369124233722687], [384.0, 217.0, 0.2142457515001297], [388.0, 182.0, 0.2175724357366562]])

# Divide the X and Y values of the Kinect due to the very high values compared to others
Kt = divide(Kt,[1000.0,1000.0,1.0])

B = np.asmatrix(Bt)
K = np.asmatrix(Kt)


def ransac_loop():

    # Ransac parameters
    ransac_iterations = 5000  # Number of iterations
    n_samples = len(K)
    best_rmse = None
    best_R = None
    best_t = None

    print "Number of Baxter points: "
    print len(B)
    print "Number of Kinect points: "
    print len(K)

    for iteration in range(ransac_iterations):

        # Pick 2 random points from each dataset
        n = int(n_samples * 0.8)  # Test on 80% of the data

        k_points = np.arange(K.shape[0])
        np.random.shuffle(k_points)

        sample = k_points[:n]

        sample_k = K[sample, :]
        sample_b = B[sample, :]

        # Find the rotation and translation for these sample points
        ret_R, ret_t = rigid_transform_3D(sample_k, sample_b)

        # Test the calculated transform and rotation
        rmse = test_point(ret_R, ret_t)

        if (best_rmse is None) or (rmse < best_rmse):
            best_rmse = rmse
            best_R = ret_R
            best_t = ret_t

    print "\n\nBest RMSE: "
    print best_rmse
    print "\nBest Rotation:"
    print best_R
    print "\nBest translation:"
    print best_t


def rigid_transform_3D(A, B):
    assert len(A) == len(B)

    N = A.shape[0]  # total points

    centroid_A = mean(A, axis=0)
    centroid_B = mean(B, axis=0)

    # centre the points
    AA = A - tile(centroid_A, (N, 1))
    BB = B - tile(centroid_B, (N, 1))

    # dot is matrix multiplication for array
    H = transpose(AA) * BB

    U, S, Vt = linalg.svd(H)

    R = Vt.T * U.T

    # special reflection case
    if linalg.det(R) < 0:
        Vt[2, :] *= -1
        R = Vt.T * U.T

    t = -R * centroid_A.T + centroid_B.T

    return R, t


def test_point(ret_R, ret_t):
    K2 = (ret_R * K.T) + tile(ret_t, (1, n))
    K2 = K2.T

    # Find the error
    err = K2 - B

    err = multiply(err, err)
    err = sum(err)
    rmse = sqrt(err / n)

    return rmse


if __name__ == '__main__':
    # Test

    # number of points
    n = len(K)

    # Perform the ransac loop
    ransac_loop()
